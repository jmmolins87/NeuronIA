generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

enum BookingStatus {
  HELD
  CONFIRMED
  CANCELLED
  RESCHEDULED
  EXPIRED
}

enum BookingTokenKind {
  SESSION
  CANCEL
  RESCHEDULE
}

model Booking {
  id        String        @id @default(cuid())
  status    BookingStatus

  uid       String        @unique

  startAt   DateTime
  endAt     DateTime
  timezone  String
  locale    String
  expiresAt DateTime?

  contactName       String?
  contactEmail      String?
  contactPhone      String?
  contactClinicName String?
  contactMessage    String?

  roiData     Json?
  confirmedAt DateTime?
  cancelledAt DateTime?

  rescheduledToBookingId String?
  rescheduledToBooking   Booking? @relation("BookingReschedule", fields: [rescheduledToBookingId], references: [id], onDelete: SetNull)
  rescheduledFromBookings Booking[] @relation("BookingReschedule")

  tokens    BookingToken[]
  events    BookingEvent[]

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([startAt])
  @@index([status, startAt])
  @@index([expiresAt])
  @@index([rescheduledToBookingId])
}

model BookingToken {
  id        String          @id @default(cuid())
  bookingId String
  kind      BookingTokenKind
  tokenHash String          @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime        @default(now())

  booking   Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, kind])
  @@index([expiresAt])
}

model BookingEvent {
  id          String   @id @default(cuid())
  bookingId   String
  type        String
  payloadJson Json
  createdAt   DateTime @default(now())

  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, createdAt])
  @@index([type, createdAt])
}
