generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

enum BookingStatus {
  HELD
  CONFIRMED
  CANCELLED
  RESCHEDULED
  EXPIRED
}

enum BookingTokenKind {
  SESSION
  CANCEL
  RESCHEDULE
}

enum AgentChannel {
  WEB_FORM
  EMAIL
  WHATSAPP
}

enum AgentThreadStatus {
  OPEN
  CLOSED
}

enum AgentMessageDirection {
  IN
  OUT
}

enum AgentJobType {
  PROCESS_BOOKING_EVENT
  PROCESS_INBOUND_MESSAGE
}

enum AgentJobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

model Booking {
  id        String        @id @default(cuid())
  status    BookingStatus

  uid       String        @unique

  startAt   DateTime
  endAt     DateTime
  timezone  String
  locale    String
  expiresAt DateTime?

  contactName       String?
  contactEmail      String?
  contactPhone      String?
  contactClinicName String?
  contactMessage    String?

  roiData     Json?
  confirmedAt DateTime?
  cancelledAt DateTime?

  rescheduledToBookingId String?
  rescheduledToBooking   Booking? @relation("BookingReschedule", fields: [rescheduledToBookingId], references: [id], onDelete: SetNull)
  rescheduledFromBookings Booking[] @relation("BookingReschedule")

  tokens    BookingToken[]
  events    BookingEvent[]

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([startAt])
  @@index([status, startAt])
  @@index([expiresAt])
  @@index([rescheduledToBookingId])
}

model BookingToken {
  id        String          @id @default(cuid())
  bookingId String
  kind      BookingTokenKind
  tokenHash String          @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime        @default(now())

  booking   Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, kind])
  @@index([expiresAt])
}

model BookingEvent {
  id          String   @id @default(cuid())
  bookingId   String
  type        String
  payloadJson Json
  processedAt DateTime?
  createdAt   DateTime @default(now())

  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, createdAt])
  @@index([type, createdAt])
  @@index([processedAt])
}

model AgentThread {
  id             String            @id @default(cuid())
  channel        AgentChannel
  externalId     String
  locale         String
  customerName   String?
  customerEmail  String?
  customerPhone  String?
  status         AgentThreadStatus @default(OPEN)
  lastMessageAt  DateTime
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  messages       AgentMessage[]

  @@unique([channel, externalId])
  @@index([status, lastMessageAt])
  @@index([customerEmail])
}

model AgentMessage {
  id         String                @id @default(cuid())
  threadId   String
  direction  AgentMessageDirection
  text       String
  raw        Json
  createdAt  DateTime              @default(now())

  thread     AgentThread           @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
}

model AgentJob {
  id           String         @id @default(cuid())
  type         AgentJobType
  payload      Json
  bookingEventId String?      @unique
  runAt        DateTime
  status       AgentJobStatus @default(PENDING)
  attempts     Int            @default(0)
  lastError    String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([status, runAt])
  @@index([type, status, runAt])
}
