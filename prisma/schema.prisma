generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

enum BookingStatus {
  HELD
  CONFIRMED
  CANCELLED
  RESCHEDULED
  EXPIRED
}

enum BookingTokenKind {
  SESSION
  CANCEL
  RESCHEDULE
}

enum AgentChannel {
  WEB_FORM
  EMAIL
  WHATSAPP
}

enum AgentThreadStatus {
  OPEN
  CLOSED
}

enum AgentMessageDirection {
  IN
  OUT
}

enum AgentJobType {
  PROCESS_BOOKING_EVENT
  PROCESS_INBOUND_MESSAGE
}

enum AgentJobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

model Booking {
  id        String        @id @default(cuid())
  status    BookingStatus

  uid       String        @unique

  startAt   DateTime
  endAt     DateTime
  timezone  String
  locale    String
  expiresAt DateTime?

  contactName       String?
  contactEmail      String?
  contactPhone      String?
  contactClinicName String?
  contactMessage    String?

  roiData     Json?
  confirmedAt DateTime?
  cancelledAt DateTime?

  rescheduledToBookingId String?
  rescheduledToBooking   Booking? @relation("BookingReschedule", fields: [rescheduledToBookingId], references: [id], onDelete: SetNull)
  rescheduledFromBookings Booking[] @relation("BookingReschedule")

  tokens    BookingToken[]
  events    BookingEvent[]

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  bookingAdminAudits BookingAdminAudit[]

  @@index([startAt])
  @@index([status, startAt])
  @@index([expiresAt])
  @@index([rescheduledToBookingId])
}

model BookingToken {
  id        String          @id @default(cuid())
  bookingId String
  kind      BookingTokenKind
  tokenHash String          @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime        @default(now())

  booking   Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, kind])
  @@index([expiresAt])
}

model BookingEvent {
  id          String   @id @default(cuid())
  bookingId   String
  type        String
  payloadJson Json
  processedAt DateTime?
  createdAt   DateTime @default(now())

  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, createdAt])
  @@index([type, createdAt])
  @@index([processedAt])
}

model AgentThread {
  id             String            @id @default(cuid())
  channel        AgentChannel
  externalId     String
  locale         String
  customerName   String?
  customerEmail  String?
  customerPhone  String?
  status         AgentThreadStatus @default(OPEN)
  lastMessageAt  DateTime
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  messages       AgentMessage[]

  @@unique([channel, externalId])
  @@index([status, lastMessageAt])
  @@index([customerEmail])
}

model AgentMessage {
  id         String                @id @default(cuid())
  threadId   String
  direction  AgentMessageDirection
  text       String
  raw        Json
  createdAt  DateTime              @default(now())

  thread     AgentThread           @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
}

model AgentJob {
  id           String         @id @default(cuid())
  type         AgentJobType
  payload      Json
  bookingEventId String?      @unique
  runAt        DateTime
  status       AgentJobStatus @default(PENDING)
  attempts     Int            @default(0)
  lastError    String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([status, runAt])
  @@index([type, status, runAt])
}

// Admin System Models
enum AdminRole {
  SUPER_ADMIN
  ADMIN
}

enum AdminMode {
  REAL
  DEMO
}

model AdminUser {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  username     String    @unique
  email        String?   @unique
  passwordHash String
  
  role         AdminRole @default(ADMIN)
  mode         AdminMode @default(REAL)
  isActive     Boolean   @default(true)
  
  // Session & Login tracking
  lastLoginAt          DateTime?
  lastLoginIp          String?
  
  // Security: Account lockout
  failedLoginCount     Int       @default(0)
  lastFailedLoginAt    DateTime?
  lockedUntil          DateTime?
  
  // Relations
  auditActions         BookingAdminAudit[]
  userAuditActions     UserAdminAudit[]    @relation("AuditActor")
  userAuditTargets     UserAdminAudit[]    @relation("AuditTarget")
  sessions             AdminSession[]
  
  @@index([username])
  @@index([lockedUntil])
}

model AdminSession {
  id           String    @id @default(cuid())
  sessionToken String    @unique
  adminId      String
  
  csrfToken    String    @unique
  
  createdAt    DateTime  @default(now())
  expiresAt    DateTime
  lastUsedAt   DateTime  @default(now())
  
  ipAddress    String?
  userAgent    String?
  
  admin        AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  @@index([adminId])
  @@index([expiresAt])
  @@index([sessionToken])
}

model UserAdminAudit {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now())
  
  adminId         String
  admin           AdminUser @relation("AuditActor", fields: [adminId], references: [id], onDelete: Cascade)
  
  targetAdminId   String?
  targetAdmin     AdminUser? @relation("AuditTarget", fields: [targetAdminId], references: [id], onDelete: SetNull)
  
  action          String    // CREATE_ADMIN, DISABLE_ADMIN, RESET_PASSWORD, DEMO_LOGIN, etc.
  metadata        Json?     // { ip, userAgent, oldData, newData }
  
  @@index([adminId, createdAt])
  @@index([targetAdminId, createdAt])
  @@index([action, createdAt])
}

model BookingAdminAudit {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  adminId   String
  admin     AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  bookingId String
  booking   Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  action    String   // CANCEL, RESCHEDULE, EDIT_CONTACT, etc.
  metadata  Json?    // { oldData, newData, reason, ip, userAgent }
  
  @@index([adminId, createdAt])
  @@index([bookingId, createdAt])
  @@index([action, createdAt])
}
